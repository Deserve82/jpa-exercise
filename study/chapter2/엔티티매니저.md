# 엔티티 매니저

## 엔티티 매니저 팩토리 생성

JPA를 사용하려면 우선 persistence.xml의 정보를 사용해서 엔티티 매니저 팩토리를 생성해야 한다.
```aidl
EntityManagerFactory emf = Persistence.createEntityManagerFactory("jpabook");
```
이 코드를 통해 `META-INF/persistence.xml` 에서 이름이 같은 유닛을 찾아서 엔티티 매니저 팩토리를 생성한다.
설정 절보를 읽어서 JPA를 동작시키기 위한 객체를 만들고 데이터 베이스 커넥션 풀도 생성하므로 생성 비용이 무척이나 크다.

**그래서 반드시 애플리케이션에서는 한번만 생성하고 공유해서 사용해야 한다.** 스레드 세이프 하기 때문에 여러 스레드에서 동시에 접근해도 괜찮다.


## 엔티티 매니저 생성
팩토리에서 엔티티 매니저를 생성한다. 대부분의 기능은 엔티티 매니저에서 제공한다. DB에 유저 등록, 수정, 삭제, 조회가 가능하다.

**단, 엔티티 매니저는 데이터 베이스 커넥션과 밀접한 관계가 있으므로 스레드 간에 공유하거나 재사용을 하면 안된다.**

## 트랜잭션 관리
**JPA를 사용하면 항상 트랜잭션 안에서 데이터를 변경해야 한다.** 트랜잭션 없이 데이터를 변경하면 예외가 발생한다.


## 비지니스 로직

### 등록

엔티티를 저장하려면 엔티티 매니저의 persist() 메소드에 저장할 엔티티를 넘겨주기만 하면 된다.

### 수정
JPA는 어떤 엔티티가 변경되었는지 추적하는 기능을 가지고 있다. 따라서 엔티티 값만 바꿔주어도 update sql 을 생성해서 디비 값을 업데이트한다.

### 삭제
등록과 마찬가지로 remove()에 엔티티를 넘겨주기만하면 된다.

### 한 건 조회
find()는 @Id로 데이터베이스 테이블의 기본키와 매핑한 식별자 값으로 엔티티 하나를 조회하는 가장 단순한 조회 메소드이다.

## JPQL
테이블이 아닌 엔티티 객체를 대상으로 검색하면 데이터베이스의 모든 데이터를 애플리케이션으로 불러와서 검색해야 하는데 이건 사실상 불가능하다.
그래서 필요한 데이터만 데이터베이스를 불러오기 위해서 검색 조건이 포함된 SQL을 사용해야한다.
여기서 JPA는 JPQL이라는 쿼리 언어로 이런 문제를 해결한다.

JPQL은 엔티티 객체를 대상으로 쿼리한다. 즉, 클래스와 필드를 대상으로 한다. - 테이블이 아님에 주의. 얘는 DB 테이블을 전혀 알지 못한다.
SQL은 DB 테이블을 대상으로 쿼리한다.